"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("mqtt"),n=require("node-fetch"),e=require("@arduino/cbor-js"),r=require("jws"),o=require("rxjs"),i=require("rxjs/operators");function c(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s=c(t),u=c(n),a=c(e),p=c(r),f=function(t,n){return(f=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=n[e])})(t,n)};function h(t,n){function e(){this.constructor=t}f(t,n),t.prototype=null===n?Object.create(n):(e.prototype=n.prototype,new e)}var l=function(){return(l=Object.assign||function(t){for(var n,e=1,r=arguments.length;e<r;e++)for(var o in n=arguments[e])Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o]);return t}).apply(this,arguments)};function d(t,n,e,r){return new(e||(e=Promise))((function(o,i){function c(t){try{u(r.next(t))}catch(t){i(t)}}function s(t){try{u(r.throw(t))}catch(t){i(t)}}function u(t){var n;t.done?o(t.value):(n=t.value,n instanceof e?n:new e((function(t){t(n)}))).then(c,s)}u((r=r.apply(t,n||[])).next())}))}function b(t,n){var e,r,o,i,c={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(e)throw new TypeError("Generator is already executing.");for(;c;)try{if(e=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,r=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(!(o=c.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){c=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){c.label=i[1];break}if(6===i[0]&&c.label<o[1]){c.label=o[1],o=i;break}if(o&&c.label<o[2]){c.label=o[2],c.ops.push(i);break}o[2]&&c.ops.pop(),c.trys.pop();continue}i=n.call(t,c)}catch(t){i=[6,t],r=0}finally{e=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}function v(t){return t&&"string"==typeof t}!function(t){function n(n,e){var r=t.call(this,e)||this;r.code=n,r.name=r.constructor.name;try{Error.captureStackTrace(r,r.constructor)}catch(t){}return r}h(n,t)}(Error);var y=a.default;function w(t){return!!t.n}function m(t){return null==t}function g(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return t.find((function(t){return!m(t)}))}function k(t){return w(t)?g(t.v,t.vs,t.vb):g(t[2],t[3],t[4])}function E(t){return w(t)?t.n:t[0]}function C(t){var n={},e=null;return Object.keys(t).forEach((function(r){switch(r){case"bn":e=-2;break;case"bt":e=-3;break;case"bu":e=-4;break;case"bv":e=-5;break;case"bs":e=-6;break;case"bver":e=-1;break;case"n":e=0;break;case"u":e=1;break;case"v":e=2;break;case"vs":e=3;break;case"vb":e=4;break;case"vd":e=8;break;case"s":e=5;break;case"t":e=6;break;case"ut":e=7;break;default:e=r}n[e]=t[r]})),n}function T(t,n,e,r){var o={};return-1!==e&&(o.bt=e||(new Date).getTime()),o.n=n,r&&(o.bn="urn:uuid:"+r),function(t){return t&&"number"==typeof t}(t)&&(o.v=t),v(t)&&(o.vs=t),function(t){return t&&"boolean"==typeof t}(t)&&(o.vb=t),o}function P(t,n,e,r,o){if(e&&!Number.isInteger(e))throw new Error("Timestamp must be Integer");if(void 0===t||"string"!=typeof t)throw new Error("Name must be a valid string");if(function(t){return t&&"object"==typeof t}(n))return Object.keys(n).map((function(r,i){return T(n[r],t+":"+r,0===i?e:-1,0===i?o:void 0)})).map((function(t){return r?C(t):t}));var i=T(n,t,e,o);return r&&(i=C(i)),i}var j,_=Object.freeze({__proto__:null,CBOR:y,isPropertyValue:w,isNil:m,takeFrom:g,valueFrom:k,nameFrom:E,toString:function(t,n){return function(t){for(var n="",e=new Uint8Array(t),r=e.byteLength,o=0;o<r;o+=1)n+=String.fromCharCode(e[o]);return window.btoa(n)}(y.encode(t,n))},toCloudProtocolV2:C,format:T,parse:P});exports.CloudOptions=void 0,j=function(){return null},(exports.CloudOptions||(exports.CloudOptions={})).DEFAULT={host:"iot.arduino.cc",useCloudProtocolV2:!0,onOffline:j,onConnected:j,onDisconnect:j};var O=function(){function t(){}return t.Create=function(t){return new(function(){function n(){}return n.prototype.post=function(t,n,e){return this.execute(t,"post",n,e)},n.prototype.execute=function(n,e,r,o){return d(this,void 0,void 0,(function(){var i,c,s,u,a;return b(this,(function(p){switch(p.label){case 0:return[4,t(n,{method:e,body:r,headers:o})];case 1:return i=p.sent(),c=this.mapFrom(i.headers),[4,i.text()];case 2:if(s=p.sent(),u=c["content-type"]||"",a=u.match("json")&&s?JSON.parse(s):s,i.status>=400)throw new Error(JSON.stringify({payload:a,status:i.status}));return[2,a]}}))}))},n.prototype.mapFrom=function(t){var n={};return t.forEach((function(t,e){return n[e]=t})),n},n}())},t}(),x={clean:!0,keepalive:30,properties:{},protocolVersion:4,connectTimeout:3e4},I=function(){function t(t,n,e,r){if(this.host=t,this.username=n,this.password=e,this.mqttConnect=r,!n)throw new Error("connection failed: you need to provide a valid username");if(!e)throw new Error("connection failed: you need to provide a valid password");if(!t)throw new Error("connection failed: you need to provide a valid host (broker)");this.options=l(l({},x),{username:n,password:e,clientId:n})}return Object.defineProperty(t.prototype,"client",{get:function(){return this._client},set:function(t){var n=this;this._client=t;var e=this.messages=new o.Subject;this._client.on("message",(function(t,r){t.indexOf("/s/o")>-1?e.next({topic:t,value:r.toString()}):n.messagesFrom(t,r).forEach((function(t){return e.next(t)}))}))},enumerable:!1,configurable:!0}),t.prototype.connect=function(t){var n=this;return new Promise((function(e,r){n.options=t?l(l({},n.options),t):n.options,n.client=n.mqttConnect(n.host,n.options),n.client.once("connect",(function(){return e(!0)})),n.client.once("close",(function(){return r(new Error("connection failed: client not connected"))}))}))},t.prototype.end=function(t,n,e){return this.client.end(t,n,e),this},t.prototype.reconnect=function(t){return this.client.reconnect(t),this},t.prototype.unsubscribe=function(t,n,e){return this.client.subscribe(t,n,e),this},t.prototype.publish=function(t,n,e,r){return this.client.publish(t,n,e,r),this},t.prototype.subscribe=function(t,n){return this.client.subscribe(t,n),this},t.prototype.messagesFrom=function(t,n){var e,r="",o="",i="",c={},s=[];return y.decode(function(t){for(var n=new ArrayBuffer(t.length),e=new Uint8Array(n),r=0;r<t.length;++r)e[r]=t[r];return n}(n)).forEach((function(n){var e,u=k(n);e=E(n).split(":"),r=e[0],o=e[1],""===i&&(i=r),i!==r&&(s.push({topic:t,propertyName:i,value:c}),i=r,c={}),o?c[o]=u:c=u})),(e=c)&&"object"==typeof e&&0==Object.keys(e).length||s.push({topic:t,propertyName:r,value:c}),s},t}();!function(t){t.WithToken=function(t){function n(n,e,r){var o=t.call(this,n,p.default.decode(e).payload["http://arduino.cc/id"],e,r)||this;return o.token=e,o}return h(n,t),n.prototype.connect=function(n){return d(this,void 0,void 0,(function(){return b(this,(function(e){switch(e.label){case 0:return[4,t.prototype.connect.call(this,n)];case 1:return e.sent(),this.token=this.options.password,[2,!0]}}))}))},n.prototype.updateToken=function(t){return d(this,void 0,void 0,(function(){var n;return b(this,(function(e){switch(e.label){case 0:e.label=1;case 1:return e.trys.push([1,3,,5]),this.end(),[4,this.connect(l(l({},this.options),{password:t}))];case 2:return e.sent(),[3,5];case 3:return n=e.sent(),console.error(n),[4,new Promise((function(t){return setTimeout(t,5e3)}))];case 4:return e.sent(),[3,5];case 5:return[3,0];case 6:return[2]}}))}))},n.prototype.getToken=function(){return this.token},n}(t)}(I||(I={}));var q=function(){function t(t,n){this.connection=t,this.options=n}return t.prototype.disconnect=function(){var t=this;return new Promise((function(n,e){if(!t.connection)return e(new Error("disconnection failed: connection closed"));try{t.connection.end(!0)}catch(t){return e(t)}return t.connection=null,n()}))},t.prototype.reconnect=function(){return d(this,void 0,void 0,(function(){return b(this,(function(t){return this.connection.reconnect(),[2]}))}))},t.prototype._sendProperty=function(t,n,e,r){return void 0===r&&(r=(new Date).getTime()),d(this,void 0,void 0,(function(){var o,i;return b(this,(function(c){if(r&&!Number.isInteger(r))throw new Error("send message failed: timestamp must be Integer");if(!v(n))throw new Error("send message failed: name must be a valid string");return o=P(n,e,r,this.options.useCloudProtocolV2,null),i=y.encode(function(t){return t&&Array.isArray(t)}(o)?o:[o],this.options.useCloudProtocolV2),[2,this.sendMessage(t,i)]}))}))},t.prototype.sendMessage=function(t,n){return d(this,void 0,void 0,(function(){var e=this;return b(this,(function(r){return[2,new Promise((function(r,o){if(!e.connection)return o(new Error("send message failed: no connection found"));var i=v(n)?Buffer.from(n,"utf8"):n;return e.connection.publish(t,function(t){for(var n=Buffer.alloc(t.byteLength),e=new Uint8Array(t),r=0;r<n.length;++r)n[r]=e[r];return n}(i),{qos:1,retain:!1}),r()}))]}))}))},t.prototype.observe=function(t){var n,e=this;if(!this.connection)throw new Error("subscription failed: no connection found");var r=new o.Subject;this.connection.subscribe(t,(function(o){if(o)throw new Error("subscription failed: "+o.toString());n=e.connection.messages.pipe(i.filter((function(n){return n.topic===t}))).subscribe((function(t){return r.next(t)}))}));var c=r.unsubscribe;return r.unsubscribe=function(){n.unsubscribe(),c()},r},t.prototype.unsubscribe=function(t){var n=this;return new Promise((function(e,r){return n.connection?n.connection.unsubscribe(t,null,(function(t){return t?r():e()})):r(new Error("unsubscribe failed: no connection found"))}))},t}(),S=function(t){function n(){var n=null!==t&&t.apply(this,arguments)||this;return n.subscriptions={},n.propertiesCbs={},n.callbacks={},n}return h(n,t),n.prototype.disconnect=function(){return d(this,void 0,void 0,(function(){var n=this;return b(this,(function(e){switch(e.label){case 0:return[4,t.prototype.disconnect.call(this)];case 1:return e.sent(),Object.values(this.subscriptions).forEach((function(t,e){t.forEach((function(t){return t.unsubscribe()})),delete n.callbacks[e],delete n.propertiesCbs[e],delete n.subscriptions[e]})),[2]}}))}))},n.prototype.getToken=function(){return this.connection.getToken()},n.prototype.updateToken=function(t){return this.connection.updateToken(t)},n.prototype.sendProperty=function(n,e,r,o){return t.prototype._sendProperty.call(this,"/a/t/"+n+"/e/i",e,r,o)},n.prototype.onPropertyValue=function(t,n,e){if(!n)throw new Error("Invalid property name");if("function"!=typeof e)throw new Error("Invalid callback");var r="/a/t/"+t+"/e/o";this.propertiesCbs[r]=this.propertiesCbs[r]||[],this.subscriptions[r]=this.subscriptions[r]||[],this.propertiesCbs[r].push({thingId:t,name:n,cb:e}),this.subscriptions[r].push(this.observe(r).pipe(i.filter((function(t){return t.propertyName===n}))).subscribe((function(t){return e(t.value)})))},n}(q),A=function(){function t(t,n){this.client=t,this.mqttConnect=n}return t.prototype.canBuild=function(t){return!!t.clientId},t.prototype.build=function(t){return d(this,void 0,void 0,(function(){var n;return b(this,(function(e){switch(e.label){case 0:return[4,this.connection(t)];case 1:return n=e.sent(),[2,new S(n,t)]}}))}))},t.prototype.connection=function(t){return d(this,void 0,void 0,(function(){var n,e,r,o,i,c,s;return b(this,(function(u){switch(u.label){case 0:return n=t.apiUrl,e=void 0===n?"https://api2.arduino.cc/iot/v1/clients/token":n,r={"content-type":"application/x-www-form-urlencoded"},(o=new URLSearchParams).append("client_id",t.clientId),o.append("grant_type","client_credentials"),o.append("client_secret",t.clientSecret),o.append("audience",t.audience||"https://api2.arduino.cc/iot"),[4,this.client.post(e,o,r)];case 1:return i=u.sent().access_token,c="wss://wss."+t.host+":"+(t.port||8443)+"/mqtt",[4,(s=new I.WithToken(c,i,this.mqttConnect)).connect()];case 2:return u.sent(),[2,s]}}))}))},t}(),N=function(){function t(t){this.mqttConnect=t}return t.prototype.canBuild=function(t){return!!t.token},t.prototype.build=function(t){return d(this,void 0,void 0,(function(){var n;return b(this,(function(e){switch(e.label){case 0:return[4,this.connection(t)];case 1:return n=e.sent(),[2,new S(n,t)]}}))}))},t.prototype.connection=function(t){var n=t.host,e=t.port,r=t.token;return d(this,void 0,void 0,(function(){var t;return b(this,(function(o){switch(o.label){case 0:return[4,(t=new I.WithToken("wss://wss."+n+":"+(e||8443)+"/mqtt",r,this.mqttConnect)).connect()];case 1:return o.sent(),[2,t]}}))}))},t}(),R=function(t){function n(n,e,r){var o=t.call(this,n,e)||this;return o.deviceTopic=r,o.propertiesCbs={},o.observe(o.deviceTopic).subscribe((function(t){var n=t.value;return o.onThingIdReceived(n)})),o}return h(n,t),n.prototype.disconnect=function(){return d(this,void 0,void 0,(function(){return b(this,(function(n){switch(n.label){case 0:return[4,t.prototype.disconnect.call(this)];case 1:return n.sent(),this.propertiesCbs={},this.subscription.unsubscribe(),[2]}}))}))},n.prototype.onThingIdReceived=function(t){var n=this;t?(console.log("found association to thing:",t),this.thingId=t,this.onThingResponse&&this.onThingResponse(t),this.subscription=this.observe("/a/t/"+this.thingId+"/e/i").subscribe((function(t){(n.propertiesCbs[t.propertyName]||[]).forEach((function(n){return n(t.value)}))}))):this.onThingRejection&&this.onThingRejection(new Error("Error: no thing associated"))},n.prototype.sendProperty=function(n,e,r){return d(this,void 0,void 0,(function(){return b(this,(function(o){if(!this.thingId)throw new Error("sendProperty failed: no thing associated");return[2,t.prototype._sendProperty.call(this,"/a/t/"+this.thingId+"/e/o",n,e,r)]}))}))},n.prototype.onPropertyValue=function(t,n){if(!t)throw new Error("onPropertyValue failed: invalid property name");if("function"!=typeof n)throw new Error("onPropertyValue failed: invalid callback");this.propertiesCbs[t]=this.propertiesCbs[t]||[],this.propertiesCbs[t].push(n)},n.prototype.getThing=function(){return d(this,void 0,void 0,(function(){var t=this;return b(this,(function(n){return this.thingId?[2,this.thingId]:[2,new Promise((function(n,e){t.onThingResponse=n,t.onThingRejection=e,setTimeout((function(){return e(new Error("Error: no thing associated"))}),1e4)}))]}))}))},n}(q),V=function(){function t(t){this.mqttConnect=t}return t.prototype.canBuild=function(t){return!!t.secretKey},t.prototype.build=function(t){return d(this,void 0,void 0,(function(){var n,e;return b(this,(function(r){switch(r.label){case 0:return[4,this.connection(t)];case 1:return n=r.sent(),[2,(e=new R(n,t,"/a/d/"+t.deviceId+"/e/i")).getThing().then((function(){return e}))]}}))}))},t.prototype.connection=function(t){return d(this,void 0,void 0,(function(){var n,e;return b(this,(function(r){switch(r.label){case 0:return n="mqtts://mqtts-up."+t.host+":"+(t.port||8884),[4,(e=new I(n,t.deviceId,t.secretKey,this.mqttConnect)).connect()];case 1:return r.sent(),[2,e]}}))}))},t}(),F=function(t){var n=this;return{connect:function(e){return d(n,void 0,void 0,(function(){var n;return b(this,(function(r){if(e=l(l({},exports.CloudOptions.DEFAULT),e),!(n=t.find((function(t){return t.canBuild(e)}))))throw new Error("connection failed: options not valid");return[2,n.build(e)]}))}))}}}([new N(s.default.connect),new V(s.default.connect),new A(O.Create(u.default),s.default.connect)]);exports.ArduinoIoTCloud=F,exports.SenML=_;
//# sourceMappingURL=index.js.map
